<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2D Echo Reporting</title>
  <style>
    :root { --bg: #f8fafc; --border: #cbd5e1; --accent: #ea580c; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { background: var(--bg); padding: 15px; }

    /* =========================================
       LOCK SCREEN STYLES
       ========================================= */
    #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; background: #0f172a; color: #fff; z-index: 9999; overflow: hidden; }
    .datetime { position: absolute; top: 30px; right: 40px; text-align: right; font-size: .85rem; opacity: .7; line-height: 1.4; z-index: 5; }
    #auth-screen::before { content: ""; position: absolute; inset: 0; background: linear-gradient(rgba(255,255,255,.025) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,.025) 1px, transparent 1px); background-size: 50px 50px; animation: drift 60s linear infinite; z-index: 0; }
    @keyframes drift { from {background-position:0 0,0 0} to {background-position:50px 50px,50px 50px} }
    .blob { position: absolute; border-radius: 50%; filter: blur(120px); opacity: .08; will-change: transform; z-index: 1; }
    .blob1 { width: 600px; height: 600px; background: #ea580c; top: -200px; left: -200px; animation: float1 40s linear infinite alternate; }
    .blob2 { width: 500px; height: 500px; background: #3b82f6; bottom: -200px; right: -150px; animation: float2 55s linear infinite alternate; }
    .blob3 { width: 400px; height: 400px; background: #22c55e; top: 30%; left: 60%; animation: float3 70s linear infinite alternate; }
    @keyframes float1 { from {transform:translate3d(0,0,0)} to {transform:translate3d(120px,80px,0)} }
    @keyframes float2 { from {transform:translate3d(0,0,0)} to {transform:translate3d(-140px,-100px,0)} }
    @keyframes float3 { from {transform:translate3d(0,0,0)} to {transform:translate3d(-100px,120px,0)} }
    .ecg { position: absolute; bottom: 25%; width: 100%; height: 140px; opacity: .05; z-index: 2; }
    .ecg path { stroke: var(--accent); stroke-width: 2; fill: none; stroke-dasharray: 1200; stroke-dashoffset: 1200; animation: ecgMove 6s linear infinite; }
    @keyframes ecgMove { to {stroke-dashoffset:0} }
    .auth-wrapper { text-align: center; width: 420px; z-index: 10; position: relative; }
    .page-title { font-size: 2.2rem; font-weight: 500; margin-bottom: 50px; letter-spacing: .5px; }
    .dev-label { font-size: .75rem; opacity: .6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
    .dr-name { font-size: 1.3rem; font-weight: 500; }
    .separator { width: 60px; height: 1px; background: rgba(255,255,255,.3); margin: 12px auto; }
    .credentials { font-size: .75rem; opacity: .7; line-height: 1.5; }
    #hidden-pin { position: absolute; opacity: 0; pointer-events: none; }
    .auth-message { margin-top: 40px; height: 24px; font-size: .85rem; opacity: .8; }
    .auth-success { color: #22c55e; }
    .auth-error { color: #ef4444; }
    @keyframes shake { 0% {transform:translateX(0)} 25% {transform:translateX(-6px)} 50% {transform:translateX(6px)} 75% {transform:translateX(-6px)} 100% {transform:translateX(0)} }
    .shake { animation: shake .35s ease; }

    /* =========================================
       APP STYLES
       ========================================= */
    #app-screen { display: none; max-width: 1400px; margin: 0 auto; padding-bottom: 40px; }
    .app-layout { display: flex; gap: 20px; align-items: flex-start; }
    .form-section { flex: 1; min-width: 0; }
    .conclusion-section { width: 400px; position: sticky; top: 15px; height: calc(100vh - 30px); display: flex; flex-direction: column; }
    .panel { background: #fff; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 12px; }
    .panel h3 { color: var(--accent); font-size: .9rem; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
    .flex-row { display: flex; flex-wrap: wrap; gap: 12px 15px; }
    .v-divider { width: 1px; background: var(--border); margin: 0 5px; min-height: 40px; }
    .valve-box { border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 6px; margin-bottom: 12px; background: #f8fafc; }
    .valve-title { font-size: .75rem; font-weight: 700; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
    .ig { display: flex; flex-direction: column; gap: 2px; width: 75px; }
    .ig-med { width: 100px; }
    .ig-wide { width: 180px; }
    .ig label { font-size: .7rem; font-weight: 700; color: #64748b; white-space: nowrap; }
    .ig input, .ig select { padding: 4px; border: 1px solid var(--border); border-radius: 4px; font-size: .85rem; text-align: center; width: 100%; transition: .2s; }
    .ig input[type="text"]:not(.auto-calc) { text-align: left; }
    .auto-calc { background: #f1f5f9; font-weight: 700; color: var(--accent); }
    button { background: var(--accent); color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: .85rem; }
    .btn-small { padding: 4px 8px; font-size: .75rem; border-radius: 4px; }
    .btn-red { background: #ef4444; }
    .btn-clear { background: #ef4444; margin-right: 5px; }
    .btn-ref { background: #3b82f6; margin-right: 5px; }
    .btn-map { background: #8b5cf6; margin-right: 5px; }
    .btn-print { background: #10b981; }
    .pill { background: #f1f5f9; color: #475569; border: 1px solid var(--border); padding: 6px 12px; border-radius: 20px; font-size: .8rem; font-weight: 600; cursor: pointer; transition: .2s; margin-bottom: 4px; }
    .pill.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .smart-editor { flex: 1; width: 100%; min-height: 250px; padding: 15px; border: 1px solid var(--border); border-radius: 4px; font-size: 14.5px; line-height: 1.6; background: #fff; outline: 0; overflow-y: auto; }
    .smart-editor:focus { border-color: var(--accent); }
    .ref-panel { display: none; background: #e0f2fe; border-color: #7dd3fc; }
    .ref-table { width: 100%; border-collapse: collapse; font-size: .8rem; margin-bottom: 10px; background: #fff; }
    .ref-table td, .ref-table th { border: 1px solid #bae6fd; padding: 6px; text-align: center; }
    .ref-table th { background: #0284c7; color: #fff; }
    .rwma-container { display: flex; gap: 20px; align-items: center; justify-content: center; padding: 10px 0; }
    .rwma-path:hover { opacity: .8; }
    .rwma-legend { display: flex; gap: 15px; font-size: .75rem; font-weight: 700; color: #475569; justify-content: center; margin-top: 10px; }
    .leg-box { width: 12px; height: 12px; border: 1px solid #cbd5e1; border-radius: 2px; display: inline-block; vertical-align: middle; margin-right: 4px; }
    .loading-pulse { animation: pulse 1s infinite alternate; }
    @keyframes pulse { from {opacity: 1} to {opacity: .4} }

    /* =========================================
       PRINT STYLES
       ========================================= */
    #print-layout-1page, #print-layout-2page { display: none; }
    @media print {
      @page { size: A4; margin: 12mm; }
      body { background: #fff; padding: 0; color: #000; font-family: "Times New Roman", Times, serif; font-size: 11pt; }
      #app-screen, #auth-screen { display: none !important; }
      .print-active { display: block !important; width: 100%; margin: 0 auto; line-height: 1.3; }
      .letterhead-spacer { display: block; width: 100%; height: 1.8cm; }
      .print-title { text-align: center; font-size: 13pt; font-weight: 700; text-decoration: underline; margin-bottom: 15px; }
      .pt-val { font-weight: 400; margin-left: 5px; }
      .disclaimer { border-top: 1px solid #000; color: #444; text-align: justify; page-break-inside: avoid; }
      #print-layout-1page .pt-info-container { display: flex; flex-direction: column; gap: 6px; border-bottom: 1px solid #000; padding-bottom: 8px; margin-bottom: 10px; font-weight: 700; font-size: 10.5pt; }
      #print-layout-1page .pt-info-row { display: flex; justify-content: space-between; align-items: center; }
      #print-layout-1page .dyn-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 8px; }
      #print-layout-1page .dyn-table td { padding: 2px 4px; vertical-align: middle; border: 1px solid #000; font-size: 9.5pt; line-height: 1.1; }
      #print-layout-1page .dyn-table td.lbl { font-weight: 400; color: #222; width: 25%; }
      #print-layout-1page .dyn-table td.val { font-weight: 700; white-space: nowrap; width: 25%; }
      #print-layout-1page .section-title { font-weight: 700; text-decoration: underline; margin: 8px 0 4px 0; font-size: 10.5pt; }
      #print-layout-1page .conclusion-text { margin-top: 4px; line-height: 1.35; font-size: 10.5pt; }
      #print-layout-1page .print-footer { margin-top: 15px; text-align: left; font-weight: 700; line-height: 1.2; font-size: 10pt; }
      #print-layout-1page .disclaimer { margin-top: 15px; padding-top: 6px; font-size: 8pt; line-height: 1.2; }
      
      #print-layout-2page .page-1-wrapper { display: block; }
      #print-layout-2page .pt-info-container { display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 20px; font-weight: 700; font-size: 11pt; }
      #print-layout-2page .pt-info-row { display: flex; justify-content: space-between; align-items: center; }
      #print-layout-2page .section-title { font-weight: 700; text-decoration: underline; margin: 15px 0 10px 0; font-size: 12.5pt; }
      #print-layout-2page .conclusion-text { margin-top: 5px; line-height: 1.7; font-size: 12pt; text-align: justify; }
      #print-layout-2page .footer-wrapper { margin-top: 30px; page-break-inside: avoid; }
      #print-layout-2page .print-footer { text-align: left; font-weight: 700; line-height: 1.4; font-size: 11.5pt; padding-bottom: 15px; }
      #print-layout-2page .disclaimer { padding-top: 10px; font-size: 8.5pt; line-height: 1.3; }
      #print-layout-2page .dyn-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 15px; }
      #print-layout-2page .dyn-table td { padding: 4px 6px; vertical-align: middle; border: 1px solid #000; font-size: 10.5pt; }
      #print-layout-2page .dyn-table td.lbl { font-weight: 400; color: #222; width: 25%; }
      #print-layout-2page .dyn-table td.val { font-weight: 700; white-space: nowrap; width: 25%; }
      #print-layout-2page .rwma-container { gap: 15px; padding: 0; margin-bottom: 10px; display: flex; justify-content: center; }
      #print-layout-2page .rwma-container svg { height: 160px; width: auto; }
      #print-layout-2page .rwma-container > div > div { font-size: 10pt !important; margin-bottom: 4px !important; }
      #print-layout-2page .rwma-legend { font-size: 9pt; margin-top: 5px; margin-bottom: 15px; display: flex; justify-content: center; gap: 15px; }
      .page-break { page-break-before: always; break-before: page; }
    }
  </style>
</head>
<body>

<div id="auth-screen">
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>
  <div class="blob blob3"></div>
  <div class="datetime">
    <div id="current-date"></div>
    <div id="current-time"></div>
  </div>
  <svg class="ecg" viewBox="0 0 1000 200" preserveAspectRatio="none">
    <path d="M0 100 L150 100 L200 40 L250 160 L300 100 L1000 100"/>
  </svg>
  <div class="auth-wrapper">
    <div class="page-title">2D ECHO Reporting</div>
    <div class="dev-label">Developed by</div>
    <div class="dr-name">Dr. Mit Panchani</div>
    <div class="separator"></div>
    <div class="credentials">MD (General Medicine)<br>Fellow in 2D Echocardiography</div>
    <div id="auth-message" class="auth-message"></div>
  </div>
  <input type="password" id="hidden-pin" maxlength="4" autofocus>
</div>

<div id="app-screen">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
    <h2>2D ECHO REPORTING</h2>
    <div>
      <button class="btn-map" onclick="toggleMap()">üó∫Ô∏è Artery Map</button> 
      <button class="btn-ref" onclick="toggleRef()">üìñ ASE Guidelines</button> 
      <button class="btn-clear" onclick="clearForm()">üóëÔ∏è Clear</button> 
      <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
    </div>
  </div>

  <div id="map-panel" class="panel ref-panel" style="background:#f0fdf4; border-color:#86efac">
    <h3>Coronary Artery Territories Reference (17-Segment)</h3>
    <div style="padding:10px 0">
      <table class="ref-table" style="width:100%; background:#fff; margin:0">
        <tr>
          <th style="background:#ef4444; width:33%;">LAD Territory</th>
          <th style="background:#3b82f6; width:33%;">RCA Territory</th>
          <th style="background:#eab308; width:33%;">LCx Territory</th>
        </tr>
        <tr>
          <td style="text-align:left; padding: 8px 15px; vertical-align:top; line-height: 1.6;">
            ‚Ä¢ Anterior<br>
            ‚Ä¢ Anteroseptal<br>
            ‚Ä¢ Apical anterior<br>
            ‚Ä¢ Apical septal<br>
            ‚Ä¢ Apical cap <i>(Primary)</i>
          </td>
          <td style="text-align:left; padding: 8px 15px; vertical-align:top; line-height: 1.6;">
            ‚Ä¢ Inferior<br>
            ‚Ä¢ Inferoseptal<br>
            ‚Ä¢ Apical inferior
          </td>
          <td style="text-align:left; padding: 8px 15px; vertical-align:top; line-height: 1.6;">
            ‚Ä¢ Anterolateral<br>
            ‚Ä¢ Inferolateral<br>
            ‚Ä¢ Apical lateral
          </td>
        </tr>
      </table>
    </div>
  </div>

  <div id="ref-panel" class="panel ref-panel">
    <h3>ASE / EACVI Reference Guidelines (Sex-Indexed)</h3>
    <table class="ref-table">
      <tr><th>PARAMETER</th><th>NORMAL (FEMALE)</th><th>NORMAL (MALE)</th><th>MILD</th><th>MODERATE</th><th>SEVERE</th></tr>
      <tr><td><b>LVDd (mm)</b></td><td>38 - 52</td><td>42 - 58</td><td>F: 53-56 | M: 59-63</td><td>F: 57-61 | M: 64-68</td><td>F: ‚â•62 | M: ‚â•69</td></tr>
      <tr><td><b>LVPWd (mm)</b></td><td>6 - 9</td><td>6 - 10</td><td>F: 10-12 | M: 11-13</td><td>F: 13-15 | M: 14-16</td><td>F: ‚â•16 | M: ‚â•17</td></tr>
      <tr><td><b>AS (Vmax m/s)</b></td><td colspan="2">< 2.6 <i>(Sclerosis)</i></td><td>2.6 - 2.9</td><td>3.0 - 4.0</td><td>‚â• 4.0</td></tr>
      <tr><td><b>MS (Mean PG)</b></td><td colspan="2">-</td><td>< 5</td><td>5 - 10</td><td>> 10</td></tr>
      <tr><td><b>RVSP (mmHg)</b></td><td colspan="2">Normal ‚â§ 35 mmHg</td><td>36 - 45</td><td>46 - 60</td><td>> 60</td></tr>
    </table>
    <div style="font-size:.8rem; font-weight:700; color:#0369a1; margin-top: 6px;">RWT = 2(LVPWd/LVDd). If > 0.42 = Concentric Geometry. TAPSE < 16 mm = Reduced RV Function.</div>
  </div>

  <div class="app-layout">
    <div class="form-section">
      <div class="panel flex-row">
        <div class="ig ig-wide"><label>NAME</label><input type="text" id="pt-name" class="live-input"></div>
        <div class="ig"><label>AGE</label><input type="text" id="pt-age" class="live-input"></div>
        <div class="ig"><label>GENDER</label><input type="text" id="pt-gender" class="live-input"></div>
        <div class="ig ig-wide"><label>REFERRED BY</label><input type="text" id="pt-ref" class="live-input"></div>
        <div class="ig ig-med"><label>DATE</label><input type="date" id="pt-date" class="live-input"></div>
      </div>

      <div class="panel">
        <h3>Quick Notes</h3>
        <div class="flex-row" style="align-items:center">
          <button class="pill" id="p-tach" onclick="togglePill(this)" data-txt="Tachycardia noted during study">Tachycardia</button> 
          <button class="pill" id="p-brad" onclick="togglePill(this)" data-txt="Bradycardia noted during study">Bradycardia</button> 
          <button class="pill" id="p-arrh" onclick="togglePill(this)" data-txt="Arrhythmia noted during study">Arrhythmia</button> 
          <button class="pill" id="p-poor" onclick="togglePill(this)" data-txt="Poor echo window">Poor Window</button> 
          <button class="pill" id="p-lim" onclick="togglePill(this)" data-txt="Limited scan">Limited Scan</button> 
          <button class="pill" id="p-cabg" onclick="togglePill(this)" data-txt="S/P CABG">S/P CABG</button> 
          <button class="pill" id="p-ptca" onclick="togglePill(this)" data-txt="S/P PTCA">S/P PTCA</button> 
          <button class="pill" id="p-avr" onclick="togglePill(this)" data-txt="S/P AVR">S/P AVR</button> 
          <button class="pill" id="p-mvr" onclick="togglePill(this)" data-txt="S/P MVR">S/P MVR</button> 
          <button class="pill" id="p-bmv" onclick="togglePill(this)" data-txt="S/P BMV">S/P BMV</button>
          <div style="width:1px; height:20px; background:var(--border); margin:0 5px"></div> 
          <button class="pill" id="p-avs" onclick="togglePill(this)">AV Sclerosis</button> 
          <button class="pill" id="p-mac" onclick="togglePill(this)">MAC +</button>
          <div style="width:1px; height:20px; background:var(--border); margin:0 5px"></div> 
          <button class="pill" id="p-pe" onclick="togglePill(this)">Pericardial Effusion</button>
        </div>
      </div>

      <div class="panel" id="rwma-master-container">
        <h3><span>Visual RWMA Mapper (17-Segment)</span><div><button class="btn-red btn-small" onclick="clearRWMA()">‚Ü∫ Reset Map</button></div></h3>
        <div class="rwma-container" id="source-rwma">
          <div style="text-align:center"><div style="font-size:.8rem; font-weight:700; color:var(--accent); margin-bottom:5px">PSAX View</div><svg id="svg-psax" width="220" height="220" viewBox="0 0 220 220"></svg></div>
          <div style="text-align:center"><div style="font-size:.8rem; font-weight:700; color:var(--accent); margin-bottom:5px">A4CH View</div><svg id="svg-a4ch" width="140" height="220" viewBox="0 0 140 220"></svg></div>
          <div style="text-align:center"><div style="font-size:.8rem; font-weight:700; color:var(--accent); margin-bottom:5px">A2CH View</div><svg id="svg-a2ch" width="140" height="220" viewBox="0 0 140 220"></svg></div>
        </div>
        <div class="rwma-legend" id="source-legend">
          <div><span class="leg-box" style="background:#fff"></span>Normal</div>
          <div><span class="leg-box" style="background:#fef08a"></span>Hypokinetic</div>
          <div><span class="leg-box" style="background:#fed7aa"></span>Akinetic</div>
          <div><span class="leg-box" style="background:#fca5a5"></span>Dyskinetic</div>
        </div>
      </div>

      <div class="panel">
        <h3>LV Dimensions & Function</h3>
        <div class="flex-row" style="align-items:center">
          <div class="ig"><label>IVSd</label><input type="number" step="0.1" id="ivsd" class="print-dim live-input" data-lbl="IVSd (mm)"></div>
          <div class="ig"><label>LVDd</label><input type="number" step="0.1" id="lvdd" class="print-dim live-input" data-lbl="LVDd (mm)"></div>
          <div class="ig"><label>LVPWd</label><input type="number" step="0.1" id="lvpwd" class="print-dim live-input" data-lbl="LVPWd (mm)"></div>
          <div class="ig" style="margin-left:10px"><label>IVSs</label><input type="number" step="0.1" id="ivss" class="print-dim live-input" data-lbl="IVSs (mm)"></div>
          <div class="ig"><label>LVDs</label><input type="number" step="0.1" id="lvds" class="print-dim live-input" data-lbl="LVDs (mm)"></div>
          <div class="ig"><label>LVPWs</label><input type="number" step="0.1" id="lvpws" class="print-dim live-input" data-lbl="LVPWs (mm)"></div>
          <div class="v-divider"></div>
          <div class="ig"><label>LVEF (%)</label><input type="number" id="ef" class="print-dim live-input" data-lbl="LVEF (%)"></div>
          <div class="ig"><label>EPSS (mm)</label><input type="number" id="epss" class="print-dim live-input" data-lbl="EPSS (mm)"></div>
          <div class="ig"><label>HR (bpm)</label><input type="number" id="hr" class="print-dim live-input" data-lbl="HR (bpm)"></div>
        </div>
      </div>

      <div class="panel">
        <h3>Chambers & Great Vessels</h3>
        <div class="flex-row" style="align-items:center">
          <div class="ig"><label>Ao (mm)</label><input type="number" step="0.1" id="ao" class="print-dim live-input" data-lbl="Ao (mm)"></div>
          <div class="ig"><label>LA (mm)</label><input type="number" step="0.1" id="la" class="print-dim live-input" data-lbl="LA (mm)"></div>
          <div class="ig"><label>LA/Ao</label><input type="text" id="laao" class="print-dim auto-calc" data-lbl="LA/Ao" readonly></div>
          <div class="v-divider"></div>
          <div class="ig"><label>RA (mm)</label><input type="number" id="ra" class="print-dim live-input" data-lbl="RA Size (mm)"></div>
          <div class="ig"><label>RV (mm)</label><input type="number" id="rv" class="print-dim live-input" data-lbl="RV Size (mm)"></div>
          <div class="v-divider"></div>
          <div class="ig"><label>MPA (mm)</label><input type="number" id="mpa" class="print-dim live-input" data-lbl="MPA (mm)"></div>
          <div class="ig"><label>LPA (mm)</label><input type="number" id="lpa" class="print-dim live-input" data-lbl="LPA (mm)"></div>
          <div class="ig"><label>RPA (mm)</label><input type="number" id="rpa" class="print-dim live-input" data-lbl="RPA (mm)"></div>
        </div>
      </div>

      <div class="panel">
        <h3>Doppler</h3>
        <div class="valve-box">
          <div class="valve-title">Mitral Valve</div>
          <div class="flex-row">
            <div class="ig"><label>MV E (m/s)</label><input type="number" step="0.01" id="mv-e" class="print-dop live-input" data-lbl="MV Peak E (m/s)"></div>
            <div class="ig"><label>MV A (m/s)</label><input type="number" step="0.01" id="mv-a" class="print-dop live-input" data-lbl="MV Peak A (m/s)"></div>
            <div class="ig"><label>E/A Ratio</label><input type="text" id="ea" class="print-dop auto-calc" data-lbl="E/A Ratio" readonly></div>
            <div class="ig"><label>E/e' Ratio</label><input type="number" step="0.1" id="ee" class="print-dop live-input" data-lbl="E/e' Ratio"></div>
            <div class="ig"><label>Mean PG</label><input type="number" id="mv-mpg" class="print-dop live-input" data-lbl="MV Mean PG"></div>
            <div class="ig"><label>Peak PG</label><input type="number" id="mv-ppg" class="print-dop live-input" data-lbl="MV Peak PG"></div>
            <div class="ig ig-med"><label>MR Regurg.</label><select id="val-mr" class="live-input"><option value="None">None</option><option value="Trace">Trace</option><option value="Mild">Mild</option><option value="Moderate">Moderate</option><option value="Severe">Severe</option></select></div>
          </div>
        </div>
        <div class="valve-box">
          <div class="valve-title">Aortic, Pulmonary & Tricuspid Valves</div>
          <div class="flex-row" style="align-items:center">
            <div class="ig"><label>AV Vmax (m/s)</label><input type="number" step="0.01" id="av-v" class="print-dop live-input" data-lbl="AV Vmax (m/s)"></div>
            <div class="ig"><label>AV Max PG</label><input type="text" id="av-pg" class="print-dop auto-calc" data-lbl="AV Max PG" readonly></div>
            <div class="ig"><label>AR</label><select id="val-ar" class="live-input"><option value="None">None</option><option value="Trace">Trace</option><option value="Mild">Mild</option><option value="Moderate">Moderate</option><option value="Severe">Severe</option></select></div>
            <div class="v-divider"></div>
            <div class="ig"><label>PV Vmax (m/s)</label><input type="number" step="0.01" id="pv-v" class="print-dop live-input" data-lbl="PV Vmax (m/s)"></div>
            <div class="ig"><label>PV Max PG</label><input type="text" id="pv-pg" class="print-dop auto-calc" data-lbl="PV Max PG" readonly></div>
            <div class="ig"><label>PR</label><select id="val-pr" class="live-input"><option value="None">None</option><option value="Trace">Trace</option><option value="Mild">Mild</option><option value="Moderate">Moderate</option><option value="Severe">Severe</option></select></div>
            <div class="v-divider"></div>
            <div class="ig"><label>TR Vmax (m/s)</label><input type="number" step="0.01" id="tr-v" class="print-dop live-input" data-lbl="TR Vmax (m/s)"></div>
            <div class="ig"><label>TR Max PG</label><input type="text" id="tr-pg" class="print-dop auto-calc" data-lbl="TR Max PG" readonly></div>
          </div>
        </div>
        <div class="valve-box">
          <div class="valve-title">Pressures, Right Heart & Custom</div>
          <div class="flex-row" style="align-items:center">
            <div class="ig"><label>RVSP (mmHg)</label><input type="number" id="rvsp" class="print-dop live-input" data-lbl="RVSP (mmHg)"></div>
            <div class="ig"><label>TAPSE (mm)</label><input type="number" id="tapse" class="print-dop live-input" data-lbl="TAPSE (mm)"></div>
            <div class="ig"><label>IVC (mm)</label><input type="number" id="ivc" class="print-dop live-input" data-lbl="IVC (mm)"></div>
            <div class="v-divider"></div>
            <div class="ig ig-med"><label>Custom Name</label><input type="text" id="cust-lbl" class="live-input" placeholder="e.g., MV VTI"></div>
            <div class="ig ig-med"><label>Custom Value</label><input type="text" id="cust-val" class="print-dop custom-val live-input" data-lbl-target="cust-lbl" placeholder="e.g., 15 cm"></div>
            <button class="btn-small" onclick="addCustomField()" style="margin-top:15px; margin-left:5px">+ Add</button>
          </div>
          <div id="custom-container" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <div class="conclusion-section panel">
      <h3 style="margin-bottom:5px">REPORT <span id="loader" style="display:none; font-size:.75rem; color:var(--accent)" class="loading-pulse">Calculating...</span></h3>
      <div class="toolbar" style="margin-bottom: 5px; display: flex; gap: 5px;">
          <button class="btn-small" onclick="format('bold')" style="font-weight: bold;">B</button>
          <button class="btn-small" onclick="format('italic')" style="font-style: italic;">I</button>
          <button class="btn-small" onclick="format('underline')"><u>U</u></button>
      </div>
      <div id="conclusion" class="smart-editor" contenteditable="true"></div>
    </div>

  </div>
</div>

<div id="print-layout-1page">
  <div class="letterhead-spacer"></div>
  <div class="print-title">2D ECHOCARDIOGRAPHY REPORT</div>
  <div class="pt-info-container">
    <div class="pt-info-row">
      <div class="pt-item">NAME: <span class="pt-val" id="p-name-1"></span></div>
      <div class="pt-item">AGE: <span class="pt-val" id="p-age-1"></span></div>
      <div class="pt-item">GENDER: <span class="pt-val" id="p-gender-1"></span></div>
    </div>
    <div class="pt-info-row">
      <div class="pt-item">REFERRED BY: <span class="pt-val" id="p-ref-1"></span></div>
      <div class="pt-item">DATE: <span class="pt-val" id="p-date-1"></span></div>
    </div>
  </div>
  <div class="section-title">Dimension:</div>
  <div id="dynamic-print-dim-1"></div>
  <div class="section-title">Doppler:</div>
  <div id="dynamic-print-dop-1"></div>
  <div class="section-title">CONCLUSION:</div>
  <div id="p-conclusion-1" class="conclusion-text"></div>
  <div class="print-footer">
    <div>Dr. Mit Panchani</div>
    <div>MBBS, MD Medicine</div>
    <div>Fellow in 2D Echocardiography</div>
  </div>
  <div class="disclaimer"><b>DISCLAIMER:</b> Echocardiography is an operator-dependent imaging modality. Measurements and interpretations are subject to inter-observer variability. Image quality and structural visualization are inherently limited by patient body habitus, acoustic windows, and physiological factors. This report represents the clinical interpretation of the findings at the time of the study, is intended for clinical correlation only, and is not to be used for medico-legal purposes.</div>
</div>

<div id="print-layout-2page">
  <div class="page-1-wrapper">
    <div class="letterhead-spacer"></div>
    <div class="print-title">2D ECHOCARDIOGRAPHY REPORT</div>
    <div class="pt-info-container">
      <div class="pt-info-row">
        <div class="pt-item">NAME: <span class="pt-val" id="p-name-2"></span></div>
        <div class="pt-item">AGE: <span class="pt-val" id="p-age-2"></span></div>
        <div class="pt-item">GENDER: <span class="pt-val" id="p-gender-2"></span></div>
      </div>
      <div class="pt-info-row">
        <div class="pt-item">REFERRED BY: <span class="pt-val" id="p-ref-2"></span></div>
        <div class="pt-item">DATE: <span class="pt-val" id="p-date-2"></span></div>
      </div>
    </div>
    <div class="section-title">CONCLUSION:</div>
    <div id="p-conclusion-2" class="conclusion-text"></div>
    <div class="footer-wrapper">
      <div class="print-footer">
        <div>Dr. Mit Panchani</div>
        <div>MBBS, MD Medicine</div>
        <div>Fellow in 2D Echocardiography</div>
      </div>
      <div class="disclaimer"><b>DISCLAIMER:</b> Echocardiography is an operator-dependent imaging modality. Measurements and interpretations are subject to inter-observer variability. Image quality and structural visualization are inherently limited by patient body habitus, acoustic windows, and physiological factors. This report represents the clinical interpretation of the findings at the time of the study, is intended for clinical correlation only, and is not to be used for medico-legal purposes.</div>
    </div>
  </div>
  <div class="page-break"></div>
  <div class="section-title" style="margin-top:0">Regional Wall Motion Map:</div>
  <div id="p-rwma-visual-2"></div>
  <div id="p-rwma-legend-2"></div>
  <div class="section-title">Dimension:</div>
  <div id="dynamic-print-dim-2"></div>
  <div class="section-title">Doppler:</div>
  <div id="dynamic-print-dop-2"></div>
</div>

<script>
  const API_URL = "https://heroic-sherbet-80c87b.netlify.app/.netlify/functions/echo-brain";

  // ==========================================
  // CLOCK & LOCK SCREEN LOGIC
  // ==========================================
  function updateDateTime() {
    const now = new Date();
    document.getElementById("current-date").textContent = now.toLocaleDateString("en-GB", {day:"2-digit", month:"short", year:"numeric"});
    document.getElementById("current-time").textContent = now.toLocaleTimeString("en-GB");
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();

  (function(){
    const pinInput = document.getElementById("hidden-pin");
    const authMsg = document.getElementById("auth-message");
    const authScreen = document.getElementById("auth-screen");
    
    authScreen.addEventListener("click", () => pinInput.focus());
    
    pinInput.addEventListener("input", function() {
      if (this.value.length === 4) {
        if (btoa(this.value) === "MzM0Mg==") { 
          authMsg.textContent = atob("QWNjZXNzIEdyYW50ZWQ="); 
          authMsg.className = "auth-success";
          setTimeout(() => {
            authScreen.style.transition = "opacity 0.6s ease";
            authScreen.style.opacity = "0";
            setTimeout(() => {
              authScreen.style.display = "none";
              document.getElementById("app-screen").style.display = "block";
              initSVG();
              loadFormState();
            }, 600);
          }, 400);
        } else {
          authMsg.textContent = atob("SW5jb3JyZWN0"); 
          authMsg.className = "auth-fail";
          document.querySelector(".auth-wrapper").classList.add("shake");
          setTimeout(() => {
            this.value = "";
            document.querySelector(".auth-wrapper").classList.remove("shake");
            authMsg.textContent = "";
          }, 700);
        }
      }
    });
  })();

  function toggleRef() {
    let p = document.getElementById('ref-panel');
    p.style.display = (p.style.display === 'block') ? 'none' : 'block';
  }

  function toggleMap() {
    let p = document.getElementById('map-panel');
    p.style.display = (p.style.display === 'block') ? 'none' : 'block';
  }

  // ==========================================
  // STRICT NUMBER ENFORCER
  // ==========================================
  document.getElementById('app-screen').addEventListener('keydown', e => {
    if (e.target.type === 'number') {
      const allowedKeys = ['Backspace', 'Tab', 'ArrowLeft', 'ArrowRight', 'Delete', 'Enter'];
      const isNumOrDot = /^[0-9.]$/.test(e.key);
      if (!allowedKeys.includes(e.key) && !isNumOrDot) {
        e.preventDefault();
      }
    }
  });

  // ==========================================
  // THE NEW ASE 17-SEGMENT SVG ENGINE
  // ==========================================
  function polarToCartesian(cx, cy, r, angleDeg) {
    let angleRad = (angleDeg - 90) * Math.PI / 180.0;
    return { x: cx + (r * Math.cos(angleRad)), y: cy + (r * Math.sin(angleRad)) };
  }

  function describeArc(x, y, rIn, rOut, startAngle, endAngle) {
    let startIn = polarToCartesian(x, y, rIn, endAngle);
    let endIn = polarToCartesian(x, y, rIn, startAngle);
    let startOut = polarToCartesian(x, y, rOut, endAngle);
    let endOut = polarToCartesian(x, y, rOut, startAngle);
    let largeArc = endAngle - startAngle <= 180 ? "0" : "1";
    return ["M", startOut.x, startOut.y, "A", rOut, rOut, 0, largeArc, 0, endOut.x, endOut.y, "L", endIn.x, endIn.y, "A", rIn, rIn, 0, largeArc, 1, startIn.x, startIn.y, "Z"].join(" ");
  }

  function initSVG() {
    // 1. GENERATE THE PSAX 17-SEGMENT BULLSEYE
    let psaxHTML = '';
    
    // 1.1 Apical Cap (Center - Segment 17) -> Tagged with LAD (Primary)
    psaxHTML += `<circle id="psax-apical-cap" class="rwma-path" cx="110" cy="110" r="22" data-wall="Apical cap" data-art="LAD (Primary)" data-val="N" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Apical cap (LAD)</title></circle>`;

    // 1.2 Apical Ring (4 Segments)
    const apicalWalls = [
      { name: 'Apical anterior', art: 'LAD', s: -45, e: 45, txt: 'A' },
      { name: 'Apical lateral', art: 'LCx', s: 45, e: 135, txt: 'L' },
      { name: 'Apical inferior', art: 'RCA', s: 135, e: 225, txt: 'I' },
      { name: 'Apical septal', art: 'LAD', s: 225, e: 315, txt: 'S' }
    ];
    apicalWalls.forEach(w => {
      let id = w.name.toLowerCase().replace(/ /g, '-');
      let path = describeArc(110, 110, 22, 51, w.s, w.e);
      psaxHTML += `<path id="psax-${id}" class="rwma-path" data-wall="${w.name}" data-art="${w.art}" data-val="N" d="${path}" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>${w.name} (${w.art})</title></path>`;
    });

    // 1.3 Mid Ring (6 Segments)
    const midWalls = [
      { name: 'Mid anterior', art: 'LAD', s: -30, e: 30, txt: 'A' },
      { name: 'Mid anterolateral', art: 'LCx', s: 30, e: 90, txt: 'AL' },
      { name: 'Mid inferolateral', art: 'LCx', s: 90, e: 150, txt: 'IL' },
      { name: 'Mid inferior', art: 'RCA', s: 150, e: 210, txt: 'I' },
      { name: 'Mid inferoseptal', art: 'RCA', s: 210, e: 270, txt: 'IS' },
      { name: 'Mid anteroseptal', art: 'LAD', s: 270, e: 330, txt: 'AS' }
    ];
    midWalls.forEach(w => {
      let id = w.name.toLowerCase().replace(/ /g, '-');
      let path = describeArc(110, 110, 51, 80, w.s, w.e);
      psaxHTML += `<path id="psax-${id}" class="rwma-path" data-wall="${w.name}" data-art="${w.art}" data-val="N" d="${path}" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>${w.name} (${w.art})</title></path>`;
      let pt = polarToCartesian(110, 110, 65.5, w.s + 30);
      psaxHTML += `<text x="${pt.x}" y="${pt.y+4}" font-size="10" font-weight="bold" text-anchor="middle" fill="#475569" pointer-events="none">${w.txt}</text>`;
    });

    // 1.4 Basal Ring (6 Segments)
    const basalWalls = [
      { name: 'Basal anterior', art: 'LAD', s: -30, e: 30, txt: 'A' },
      { name: 'Basal anterolateral', art: 'LCx', s: 30, e: 90, txt: 'AL' },
      { name: 'Basal inferolateral', art: 'LCx', s: 90, e: 150, txt: 'IL' },
      { name: 'Basal inferior', art: 'RCA', s: 150, e: 210, txt: 'I' },
      { name: 'Basal inferoseptal', art: 'RCA', s: 210, e: 270, txt: 'IS' },
      { name: 'Basal anteroseptal', art: 'LAD', s: 270, e: 330, txt: 'AS' }
    ];
    basalWalls.forEach(w => {
      let id = w.name.toLowerCase().replace(/ /g, '-');
      let path = describeArc(110, 110, 80, 109, w.s, w.e);
      psaxHTML += `<path id="psax-${id}" class="rwma-path" data-wall="${w.name}" data-art="${w.art}" data-val="N" d="${path}" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>${w.name} (${w.art})</title></path>`;
      let pt = polarToCartesian(110, 110, 94.5, w.s + 30);
      psaxHTML += `<text x="${pt.x}" y="${pt.y+4}" font-size="12" font-weight="bold" text-anchor="middle" fill="#475569" pointer-events="none">${w.txt}</text>`;
    });
    
    document.getElementById('svg-psax').innerHTML = psaxHTML;

    // 2. GENERATE THE A4CH MAP
    document.getElementById('svg-a4ch').innerHTML = `
      <path id="a4-apical-cap" class="rwma-path" data-wall="Apical cap" data-art="LAD (Primary)" data-val="N" d="M 20,100 C 20,30 120,30 120,100 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Apical cap (LAD)</title></path>
      <text x="70" y="70" font-size="10" font-weight="bold" text-anchor="middle" fill="#475569" pointer-events="none">Apex</text>
      
      <path id="a4-apical-septal" class="rwma-path" data-wall="Apical septal" data-art="LAD" data-val="N" d="M 20,100 L 65,100 L 65,136 L 20,136 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Apical septal (LAD)</title></path>
      <path id="a4-mid-inferoseptal" class="rwma-path" data-wall="Mid inferoseptal" data-art="RCA" data-val="N" d="M 20,136 L 65,136 L 65,173 L 20,173 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Mid inferoseptal (RCA)</title></path>
      <path id="a4-basal-inferoseptal" class="rwma-path" data-wall="Basal inferoseptal" data-art="RCA" data-val="N" d="M 20,173 L 65,173 L 65,210 L 20,210 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Basal inferoseptal (RCA)</title></path>
      
      <path id="a4-apical-lateral" class="rwma-path" data-wall="Apical lateral" data-art="LCx" data-val="N" d="M 75,100 L 120,100 L 120,136 L 75,136 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Apical lateral (LCx)</title></path>
      <path id="a4-mid-anterolateral" class="rwma-path" data-wall="Mid anterolateral" data-art="LCx" data-val="N" d="M 75,136 L 120,136 L 120,173 L 75,173 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Mid anterolateral (LCx)</title></path>
      <path id="a4-basal-anterolateral" class="rwma-path" data-wall="Basal anterolateral" data-art="LCx" data-val="N" d="M 75,173 L 120,173 L 120,210 L 75,210 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Basal anterolateral (LCx)</title></path>
      
      <text x="42.5" y="155" font-size="10" font-weight="bold" text-anchor="middle" fill="#475569" pointer-events="none" transform="rotate(-90 42.5,155)">Septal</text>
      <text x="97.5" y="155" font-size="10" font-weight="bold" text-anchor="middle" fill="#475569" pointer-events="none" transform="rotate(90 97.5,155)">Lateral</text>
    `;

    // 3. GENERATE THE A2CH MAP (Inferior on Left, Anterior on Right)
    document.getElementById('svg-a2ch').innerHTML = `
      <path id="a2-apical-cap" class="rwma-path" data-wall="Apical cap" data-art="LAD (Primary)" data-val="N" d="M 20,100 C 20,30 120,30 120,100 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Apical cap (LAD)</title></path>
      <text x="70" y="70" font-size="10" font-weight="bold" text-anchor="middle" fill="#475569" pointer-events="none">Apex</text>
      
      <path id="a2-apical-inferior" class="rwma-path" data-wall="Apical inferior" data-art="RCA" data-val="N" d="M 20,100 L 65,100 L 65,136 L 20,136 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Apical inferior (RCA)</title></path>
      <path id="a2-mid-inferior" class="rwma-path" data-wall="Mid inferior" data-art="RCA" data-val="N" d="M 20,136 L 65,136 L 65,173 L 20,173 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Mid inferior (RCA)</title></path>
      <path id="a2-basal-inferior" class="rwma-path" data-wall="Basal inferior" data-art="RCA" data-val="N" d="M 20,173 L 65,173 L 65,210 L 20,210 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Basal inferior (RCA)</title></path>
      
      <path id="a2-apical-anterior" class="rwma-path" data-wall="Apical anterior" data-art="LAD" data-val="N" d="M 75,100 L 120,100 L 120,136 L 75,136 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Apical anterior (LAD)</title></path>
      <path id="a2-mid-anterior" class="rwma-path" data-wall="Mid anterior" data-art="LAD" data-val="N" d="M 75,136 L 120,136 L 120,173 L 75,173 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Mid anterior (LAD)</title></path>
      <path id="a2-basal-anterior" class="rwma-path" data-wall="Basal anterior" data-art="LAD" data-val="N" d="M 75,173 L 120,173 L 120,210 L 75,210 Z" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" style="cursor:pointer;" onclick="toggleRWMA(this)"><title>Basal anterior (LAD)</title></path>
      
      <text x="42.5" y="155" font-size="10" font-weight="bold" text-anchor="middle" fill="#475569" pointer-events="none" transform="rotate(-90 42.5,155)">Inferior</text>
      <text x="97.5" y="155" font-size="10" font-weight="bold" text-anchor="middle" fill="#475569" pointer-events="none" transform="rotate(90 97.5,155)">Anterior</text>
    `;
  }

  function toggleRWMA(el) {
    const states = ['N', 'Hypo', 'Aki', 'Dys'];
    const colors = { 'N': '#ffffff', 'Hypo': '#fef08a', 'Aki': '#fed7aa', 'Dys': '#fca5a5' };
    let currentIdx = states.indexOf(el.getAttribute('data-val'));
    let nextState = states[(currentIdx + 1) % states.length];
    el.setAttribute('data-val', nextState);
    el.setAttribute('fill', colors[nextState]);
    runLiveEngine();
  }

  function clearRWMA() {
    document.querySelectorAll('.rwma-path').forEach(p => {
      p.setAttribute('data-val', 'N');
      p.setAttribute('fill', '#ffffff');
    });
    runLiveEngine();
  }

  function togglePill(btn) {
    btn.classList.toggle('active');
    runLiveEngine();
  }

  function addCustomField(name = '', val = '') {
    const c = document.getElementById('custom-container');
    const d = document.createElement('div');
    d.className = 'flex-row custom-row';
    d.style.marginBottom = '8px';
    d.style.alignItems = 'center';
    d.innerHTML = `<div class="ig ig-med"><input type="text" class="cust-name live-input" placeholder="Name" value="${name}"></div><div class="ig ig-med"><input type="text" class="cust-val print-dop live-input" placeholder="Value" value="${val}"></div><button class="btn-red btn-small" onclick="this.parentElement.remove(); runLiveEngine();">X</button>`;
    c.appendChild(d);
    runLiveEngine();
  }

  // ==========================================
  // STATE MANAGEMENT
  // ==========================================
  function saveFormState() {
    let data = { rwma: {}, customFields: [], pills: [] };
    document.querySelectorAll('.live-input').forEach(el => { if (el.id) data[el.id] = el.value; });
    document.querySelectorAll('.rwma-path').forEach(p => data.rwma[p.id] = p.getAttribute('data-val'));
    document.querySelectorAll('.custom-row').forEach(r => data.customFields.push({ name: r.querySelector('.cust-name').value, val: r.querySelector('.cust-val').value }));
    document.querySelectorAll('.pill.active').forEach(p => data.pills.push(p.id));
    localStorage.setItem('echoFormState', JSON.stringify(data));
  }

  function loadFormState() {
    let saved = localStorage.getItem('echoFormState');
    if (saved) {
      let data = JSON.parse(saved);
      document.querySelectorAll('.live-input').forEach(el => { if (el.id && data[el.id] !== undefined) el.value = data[el.id]; });
      const colors = { 'N': '#ffffff', 'Hypo': '#fef08a', 'Aki': '#fed7aa', 'Dys': '#fca5a5' };
      if (data.rwma) {
        Object.keys(data.rwma).forEach(id => {
          let p = document.getElementById(id);
          if (p) {
            p.setAttribute('data-val', data.rwma[id]);
            p.setAttribute('fill', colors[data.rwma[id]]);
          }
        });
      }
      document.getElementById('custom-container').innerHTML = '';
      if (data.customFields) data.customFields.forEach(f => addCustomField(f.name, f.val));
      if (data.pills) {
        data.pills.forEach(id => {
          let p = document.getElementById(id);
          if (p) p.classList.add('active');
        });
      }
      runLiveEngine();
    } else {
      document.getElementById('pt-date').valueAsDate = new Date();
      runLiveEngine();
    }
  }

  function clearForm() {
    if (confirm("Are you sure you want to clear all data for the next patient?")) {
      localStorage.removeItem('echoFormState');
      document.querySelectorAll('.live-input').forEach(el => {
        if (el.tagName === 'SELECT') el.value = "None";
        else el.value = '';
      });
      clearRWMA();
      document.querySelectorAll('.pill.active').forEach(p => p.classList.remove('active'));
      document.getElementById('custom-container').innerHTML = '';
      document.getElementById('pt-date').valueAsDate = new Date();
      document.querySelectorAll('.auto-calc').forEach(el => el.value = '');
      runLiveEngine();
    }
  }

  // ==========================================
  // SECURE API CONNECTION
  // ==========================================
  let debounceTimer;
  async function runLiveEngine() {
    saveFormState();
    document.getElementById('loader').style.display = 'inline-block';
    
    let payload = { inputs: {}, pills: [], rwma: [] };
    document.querySelectorAll('.live-input').forEach(el => { if (el.id) payload.inputs[el.id] = el.value; });
    document.querySelectorAll('.pill.active').forEach(p => payload.pills.push({ id: p.id, txt: p.getAttribute('data-txt') }));
    document.querySelectorAll('.rwma-path').forEach(p => {
      let val = p.getAttribute('data-val');
      if (val !== 'N') payload.rwma.push({ val: val, wall: p.getAttribute('data-wall'), arts: p.getAttribute('data-art').split('/') });
    });

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (response.ok) {
          const result = await response.json();
          if (result.calculated) {
            document.getElementById('laao').value = result.calculated.laao;
            document.getElementById('ea').value = result.calculated.ea;
            document.getElementById('av-pg').value = result.calculated['av-pg'];
            document.getElementById('pv-pg').value = result.calculated['pv-pg'];
            document.getElementById('tr-pg').value = result.calculated['tr-pg'];
          }
          if (result.conclusion) document.getElementById('conclusion').innerHTML = result.conclusion;
        } else {
          console.error("API Error");
          document.getElementById('conclusion').innerHTML = "<b>[API Disconnected]</b>";
        }
      } catch (error) {
        console.error("Fetch Error:", error);
      }
      document.getElementById('loader').style.display = 'none';
    }, 400);
  }

  document.getElementById('app-screen').addEventListener('input', e => {
    if (e.target.classList.contains('live-input')) runLiveEngine();
  });

  // ==========================================
  // PRINT ENGINE LOGIC
  // ==========================================
  function build3ColTable(selector) {
    const inputs = document.querySelectorAll(selector);
    let validData = [];
    inputs.forEach(el => {
      if (el.value.trim() !== '') {
        let lbl = el.getAttribute('data-lbl');
        if (el.classList.contains('cust-val')) lbl = el.parentElement.parentElement.querySelector('.cust-name').value || 'Custom';
        validData.push({ lbl: lbl, val: el.value });
      }
    });
    if (validData.length === 0) return '<p><i>No measurements entered.</i></p>';
    let html = '<table class="dyn-table">';
    for (let i = 0; i < validData.length; i += 3) {
      html += `<tr><td class="lbl">${validData[i].lbl}</td><td class="val">${validData[i].val}</td>`;
      if (validData[i + 1]) html += `<td class="lbl">${validData[i + 1].lbl}</td><td class="val">${validData[i + 1].val}</td>`; else html += `<td class="lbl"></td><td class="val"></td>`;
      if (validData[i + 2]) html += `<td class="lbl">${validData[i + 2].lbl}</td><td class="val">${validData[i + 2].val}</td>`; else html += `<td class="lbl"></td><td class="val"></td>`;
      html += '</tr>';
    }
    return html + '</table>';
  }

  window.addEventListener('beforeprint', () => {
    let hasRwma = false;
    document.querySelectorAll('.rwma-path').forEach(p => { if (p.getAttribute('data-val') !== 'N') hasRwma = true; });
    let d = document.getElementById('pt-date').value;
    if (d) { let p = d.split('-'); d = `${p[2]}-${p[1]}-${p[0]}`; }

    if (hasRwma) {
      document.getElementById('print-layout-1page').classList.remove('print-active');
      document.getElementById('print-layout-2page').classList.add('print-active');

      document.getElementById('p-name-2').innerText = document.getElementById('pt-name').value;
      document.getElementById('p-age-2').innerText = document.getElementById('pt-age').value;
      document.getElementById('p-gender-2').innerText = document.getElementById('pt-gender').value;
      document.getElementById('p-ref-2').innerText = document.getElementById('pt-ref').value;
      document.getElementById('p-date-2').innerText = d;

      document.getElementById('p-conclusion-2').innerHTML = document.getElementById('conclusion').innerHTML;
      document.getElementById('dynamic-print-dim-2').innerHTML = build3ColTable('.print-dim');
      document.getElementById('dynamic-print-dop-2').innerHTML = build3ColTable('.print-dop');

      document.getElementById('p-rwma-visual-2').innerHTML = '';
      document.getElementById('p-rwma-visual-2').appendChild(document.getElementById('source-rwma').cloneNode(true));
      document.getElementById('p-rwma-legend-2').innerHTML = '';
      document.getElementById('p-rwma-legend-2').appendChild(document.getElementById('source-legend').cloneNode(true));
    } else {
      document.getElementById('print-layout-2page').classList.remove('print-active');
      document.getElementById('print-layout-1page').classList.add('print-active');

      document.getElementById('p-name-1').innerText = document.getElementById('pt-name').value;
      document.getElementById('p-age-1').innerText = document.getElementById('pt-age').value;
      document.getElementById('p-gender-1').innerText = document.getElementById('pt-gender').value;
      document.getElementById('p-ref-1').innerText = document.getElementById('pt-ref').value;
      document.getElementById('p-date-1').innerText = d;

      document.getElementById('dynamic-print-dim-1').innerHTML = build3ColTable('.print-dim');
      document.getElementById('dynamic-print-dop-1').innerHTML = build3ColTable('.print-dop');
      document.getElementById('p-conclusion-1').innerHTML = document.getElementById('conclusion').innerHTML;
    }
  });
// FUNCTION TO APPLY BOLD/ITALIC/UNDERLINE
function format(command) {
  document.execCommand(command, false, null);
  document.getElementById('conclusion').focus();
  runLiveEngine(); // ENSURE THE CHANGES SYNC WITH YOUR PREVIEW
}

// ALLOW HOTKEYS (CTRL+B, CTRL+I) INSIDE THE EDITOR
document.getElementById('conclusion').addEventListener('keydown', function(e) {
  if (e.ctrlKey && (e.key === 'b' || e.key === 'i' || e.key === 'u')) {
    // THE BROWSER HANDLES THE BOLDING, BUT WE NEED TO TRIGGER THE SAVE
    setTimeout(runLiveEngine, 10);
  }
});
</script>
</body>
</html>
