<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thyroid Clinic - Auto Note</title>
  <style>
    /* =========================================
       APPLICATION UI
       ========================================= */
    :root { --bg: #f8fafc; --border: #cbd5e1; --accent: #0284c7; --pill-bg: #e0f2fe; --pill-text: #0369a1; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { background: var(--bg); padding: 20px; color: #334155; overflow: hidden; }

    /* --- MAC-OS STEALTH LOCK SCREEN --- */
    #auth-screen { 
      position: fixed; inset: 0; z-index: 9999; background: radial-gradient(circle at top right, #334155, #0f172a);
      display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .mac-lock-box { text-align: center; padding: 30px; transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.5s ease; }
    .mac-avatar { width: 75px; height: 75px; margin: 0 auto 15px; border-radius: 50%; background: linear-gradient(135deg, #38bdf8, #0284c7); display: flex; justify-content: center; align-items: center; font-size: 1.8rem; font-weight: 600; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    .mac-lock-box h2 { color: #f8fafc; font-size: 1.2rem; margin-bottom: 5px; border: none; letter-spacing: 0.5px; }
    .mac-subtitle { color: #94a3b8; font-size: 0.85rem; }

    @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    .unlock-fade { opacity: 0; visibility: hidden; }
    .unlock-scale { transform: scale(1.15); opacity: 0; }

    /* --- MAIN LAYOUT --- */
    .main-wrapper { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: flex-start; }
    .left-pane { flex: 2; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    .right-pane { flex: 1; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); position: sticky; top: 20px; display: flex; flex-direction: column; height: calc(100vh - 40px); }

    h2, h3 { color: var(--accent); margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
    .section { margin-bottom: 25px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 6px; background: #fafafa; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; } /* New Grid for MOA addition */
    
    .input-group { display: flex; flex-direction: column; }
    label { font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: #475569; }
    input[type="text"], input[type="number"], input[type="date"], select, textarea { padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem; }
    
    textarea { flex-grow: 1; resize: none; font-size: 1rem; padding: 15px; line-height: 1.6; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; }

    .btn-print { background: var(--accent); color: white; border: none; padding: 12px; font-size: 1rem; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; margin-bottom: 10px; }
    .btn-print:hover { background: #0369a1; }
    .btn-copy { background: #e2e8f0; color: #334155; border: none; padding: 12px; font-size: 1rem; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; margin-bottom: 10px;}
    .btn-copy:hover { background: #cbd5e1; }
    .btn-clear { background: #ef4444; color: white; border: none; padding: 12px; font-size: 1rem; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-clear:hover { background: #dc2626; }

    .tsh-abnormal { border: 2px solid #ef4444 !important; background: #fef2f2; }
    #compliance-box { transition: 0.3s; opacity: 0.4; pointer-events: none; }
    #compliance-box.active { opacity: 1; pointer-events: auto; }

    /* =========================================
       ULTRA-PROFESSIONAL PRINT CSS (3CM FIX)
       ========================================= */
    #print-area { display: none; }
    
    @media print {
      @page { size: A4; margin: 30mm 15mm 15mm 15mm; }
      
      body { 
        background: white !important; padding: 0 !important; margin: 0 !important; 
        font-family: "Georgia", "Times New Roman", serif; font-size: 12pt; color: #000; 
      }
      
      #auth-screen, .main-wrapper { display: none !important; }

      #print-area { 
        display: block !important; position: relative !important;
        padding-top: 30mm !important; width: 100%;
      }

      .print-header-line {
        display: flex; justify-content: space-between; align-items: flex-end;
        border-bottom: 2px solid #000; padding-bottom: 6px; margin-bottom: 15px;
        font-family: Arial, sans-serif;
      }
      .ph-label { font-size: 9pt; color: #444; text-transform: uppercase; }
      .ph-val { font-size: 11pt; font-weight: bold; color: #000; margin-left: 5px; text-transform: uppercase; }

      .print-vitals-line {
        display: grid; grid-template-columns: 1fr 1fr 1fr 1.5fr; 
        background-color: #f4f4f5 !important; border: 1px solid #d4d4d8; 
        padding: 12px 0; border-radius: 4px; margin-bottom: 30px; 
        font-family: Arial, sans-serif;
      }
      .pv-item { 
        display: flex; flex-direction: column; align-items: center; 
        text-align: center; border-right: 1px solid #cbd5e1;
      }
      .pv-item:last-child { border-right: none; }
      .pv-label { font-size: 8pt; color: #555; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; }
      .pv-val { font-size: 11pt; color: #000; font-weight: bold; }
      
      .pv-tsh .pv-val { font-size: 12pt; border-bottom: 2px solid #000; padding-bottom: 1px; display: inline-block; }
      .pv-ref { font-size: 7pt; color: #666; margin-top: 2px; font-weight: normal; }

      .print-rx-body { margin-top: 10px; padding-left: 5px; min-height: 450px; }
      .rx-logo { font-family: "Times New Roman", serif; font-size: 4rem; line-height: 1; margin-bottom: 20px; color: #000; }
      .rx-content { font-size: 13pt; line-height: 1.8; white-space: pre-wrap; padding-left: 15px; color: #111; }

      .print-footer {
        display: flex; justify-content: space-between; align-items: flex-end;
        margin-top: 40px; border-top: 1px dashed #000; padding-top: 15px;
        font-family: Arial, sans-serif;
      }
      .pf-fu { font-size: 11pt; }
      .pf-sig { text-align: right; }
      .sig-name { font-size: 13pt; font-weight: bold; color: #000; margin-bottom: 3px; }
      .sig-creds { font-size: 9pt; color: #444; line-height: 1.3; }
    }
  </style>
</head>
<body>

<div id="auth-screen">
  <div class="mac-lock-box" id="mac-lock-box">
    <div class="mac-avatar">MP</div>
    <h2>Dr. Mit Panchani</h2>
    <p class="mac-subtitle">Thyroid Follow-Up Module</p>
  </div>
</div>

<div class="main-wrapper">
  <div class="left-pane">
    <h2>Thyroid OPD Automator</h2>

    <div class="section">
      <div class="grid-5">
        <div class="input-group"><label>Patient Name</label><input type="text" id="pt-name" oninput="generateNote()"></div>
        <div class="input-group"><label>Age</label><input type="number" id="pt-age" oninput="generateNote()"></div>
        <div class="input-group"><label>Gender</label><select id="pt-gender" onchange="generateNote()"><option>Female</option><option>Male</option></select></div>
        <div class="input-group"><label>MOA (Pregnancy)</label><input type="text" id="pt-moa" placeholder="e.g. 3 months" oninput="generateNote()"></div>
        <div class="input-group"><label>Date</label><input type="date" id="pt-date" onchange="generateNote()"></div>
      </div>
    </div>

    <div class="section">
      <div class="grid-3">
        <div class="input-group"><label>Diagnosis</label>
          <select id="pt-dx" onchange="generateNote()">
            <option value="K/C/O Hypothyroid">K/C/O Hypothyroid</option>
            <option value="K/C/O Hyperthyroid">K/C/O Hyperthyroid</option>
          </select>
        </div>
        <div class="input-group">
          <label>Current Dose (e.g., 100 2 tabs Sun)</label>
          <input type="text" id="pt-dose" oninput="generateNote()">
        </div>
        <div class="input-group"><label>Weight (kg)</label><input type="number" id="pt-wt" oninput="generateNote()"></div>
      </div>
      <div class="grid-3" style="margin-top: 15px;">
        <div class="input-group"><label>BP (mmHg)</label><input type="text" id="pt-bp" placeholder="e.g. 120/80"></div>
        <div class="input-group"><label>HR (/min)</label><input type="number" id="pt-hr" oninput="generateNote()"></div>
        <div class="input-group"><label>S. TSH (¬µIU/mL)</label><input type="number" id="pt-tsh" step="0.01" oninput="generateNote()"></div>
      </div>
    </div>

    <div class="section" id="compliance-box">
      <h3 style="color: #ef4444;">Abnormal TSH Detected</h3>
      <div style="display: flex; gap: 20px; margin-top: 10px;">
        <label style="cursor: pointer; font-size: 1rem;"><input type="radio" name="comp-status" id="comp-good" value="denies" onchange="generateNote()" checked> Denies poor compliance</label>
        <label style="cursor: pointer; font-size: 1rem;"><input type="radio" name="comp-status" id="comp-poor" value="present" onchange="generateNote()"> Poor compliance present</label>
      </div>
    </div>
    
    <div class="section">
      <h3>Prescription Plan</h3>
      <div class="grid-3">
        <div class="input-group"><label>New Dose (mcg)</label><input type="text" id="rx-dose" placeholder="Auto-calculated" oninput="generateNote()"></div>
        <div class="input-group"><label>Duration (Days/Months)</label><input type="text" id="rx-duration" placeholder="e.g. 1 month" oninput="generateNote()"></div>
        <div class="input-group"><label>Follow-up</label>
          <select id="rx-fu" onchange="generateNote()">
            <option value="After 6 weeks with fresh S. TSH report">After 6 weeks with fresh TSH</option>
            <option value="After 1 month with fresh S. TSH report">After 1 month with fresh TSH</option>
            <option value="After 3 months with fresh S. TSH report">After 3 months with fresh TSH</option>
            <option value="After 6 months with fresh S. TSH report">After 6 months with fresh TSH</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="right-pane">
    <h3 style="margin-bottom: 5px;">Clinical Note & Rx</h3>
    <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;">Fully editable. Paste to EMR or Print.</p>
    <textarea id="note-box" oninput="saveFormData()"></textarea>
    <div style="display: flex; flex-direction: column;">
      <button class="btn-copy" onclick="copyNote()" id="copy-btn">üìã Copy Note</button>
      <button class="btn-print" onclick="preparePrint()">üñ®Ô∏è Print Prescription</button>
      <button class="btn-clear" onclick="clearPatient()">üóëÔ∏è Clear for Next Patient</button>
    </div>
  </div>
</div>

<div id="print-area">
  
  <div class="print-header-line">
    <div class="ph-left">
      <span class="ph-label">Patient Name:</span> <span class="ph-val" id="pr-name"></span>
    </div>
    <div class="ph-center">
      <span class="ph-label">Age/Sex:</span> <span class="ph-val" id="pr-age-sex"></span>
    </div>
    <div class="ph-right">
      <span class="ph-label">Date:</span> <span class="ph-val" id="pr-date"></span>
    </div>
  </div>

  <div class="print-vitals-line">
    <div class="pv-item"><span class="pv-label">Weight</span> <span class="pv-val" id="pr-wt"></span></div>
    <div class="pv-item"><span class="pv-label">BP</span> <span class="pv-val" id="pr-bp"></span></div>
    <div class="pv-item"><span class="pv-label">HR</span> <span class="pv-val" id="pr-hr"></span></div>
    <div class="pv-item pv-tsh">
       <span class="pv-label">S. TSH</span> <span class="pv-val" id="pr-tsh"></span> 
       <span class="pv-ref">(Ref: 0.5 - 4.5 ¬µIU/mL)</span>
    </div>
  </div>

  <div class="print-rx-body">
    <div class="rx-logo">‚Ñû</div>
    <div class="rx-content" id="pr-note"></div>
  </div>

  <div class="print-footer">
    <div class="pf-fu"><b>Advised Follow-up:</b> <span id="pr-fu"></span></div>
    <div class="pf-sig">
      <div class="sig-name">Dr. Mit Panchani</div>
      <div class="sig-creds">MBBS, MD General Medicine, PGCIH<br>Fellow in 2D Echo</div>
    </div>
  </div>

</div>

<script>
  // ==========================================
  // INVISIBLE KEYSTROKE AUTHENTICATION LOGIC
  // ==========================================
  let pinBuffer = "";
  const lockScreen = document.getElementById('auth-screen');
  const lockBox = document.getElementById('mac-lock-box');

  document.addEventListener('keydown', function(e) {
    if (lockScreen.style.display === 'none') return;
    if (!isNaN(e.key) && e.key.trim() !== "") {
      pinBuffer += e.key;
      if (pinBuffer.length === 4) {
        if (pinBuffer === "3342") {
          lockBox.classList.add('unlock-scale'); lockScreen.classList.add('unlock-fade');
          setTimeout(() => { lockScreen.style.display = 'none'; document.body.style.overflow = 'auto'; pinBuffer = ""; }, 500);
        } else {
          lockBox.classList.remove('shake'); void lockBox.offsetWidth; lockBox.classList.add('shake'); pinBuffer = ""; 
        }
      }
    } else if (e.key === 'Backspace') pinBuffer = pinBuffer.slice(0, -1);
  });

  // ==========================================
  // BP SMART AUTO-FORMATTER
  // ==========================================
  document.getElementById('pt-bp').addEventListener('input', function (e) {
    if (e.inputType === 'deleteContentBackward') {
      generateNote(); return;
    }
    let v = this.value;
    if (v.length === 3 && !v.includes('/')) {
      this.value = v + '/';
    }
    generateNote();
  });

  // ==========================================
  // THYROID LOGIC ENGINE
  // ==========================================
  function generateNote() {
    const dx = document.getElementById('pt-dx').value;
    const dose = document.getElementById('pt-dose').value;
    const moa = document.getElementById('pt-moa').value;
    const tshStr = document.getElementById('pt-tsh').value;
    const manualRx = document.getElementById('rx-dose').value;
    const duration = document.getElementById('rx-duration').value;
    const compPoor = document.getElementById('comp-poor').checked;
    const compBox = document.getElementById('compliance-box');
    const tshInput = document.getElementById('pt-tsh');

    let doseText = dose ? (dose.toLowerCase().includes('mcg') || dose.toLowerCase().includes('¬µg') ? dose : dose + ' mcg') : '____ mcg';
    
    // Core Note Initialization
    let note = `${dx} on Tab. Thyroxine ${doseText}`;
    if (moa) { note += `\n* Patient is Pregnant (MOA: ${moa})`; }
    note += `\n\n`;

    let doseMatch = dose ? dose.match(/(\d+(\.\d+)?)/) : null;
    let doseNum = doseMatch ? parseFloat(doseMatch[0]) : NaN;

    let newDoseStr = "";
    if (tshStr) {
      let tsh = parseFloat(tshStr);
      if (tsh > 4.5 || tsh < 0.5) {
        compBox.classList.add('active'); tshInput.classList.add('tsh-abnormal');
        if (tsh > 4.5) {
          if (compPoor) {
            note += "TSH is raised. Poor compliance present. \nCounselled patient regarding strict empty stomach morning dosing and avoiding food/tea for 45 minutes.\n";
            newDoseStr = dose ? doseText : "____";
          } else {
            note += "TSH is raised. Patient denies poor compliance. \nDose adjustment needed.\n";
            newDoseStr = !isNaN(doseNum) ? (doseNum + 12.5) + " to " + (doseNum + 25) + " mcg" : "____ mcg";
          }
        } else {
          note += "TSH is suppressed below normal limits. \nDose adjustment needed to prevent iatrogenic thyrotoxicosis.\n";
          newDoseStr = !isNaN(doseNum) ? (doseNum - 12.5) + " to " + (doseNum - 25) + " mcg" : "____ mcg";
        }
      } else {
        compBox.classList.remove('active'); tshInput.classList.remove('tsh-abnormal');
        note += "TSH is WNL (Well controlled). \nNo active dose titration required.\n";
        newDoseStr = dose ? doseText : "____ mcg";
      }
    } else {
      compBox.classList.remove('active'); tshInput.classList.remove('tsh-abnormal');
    }

    let finalRxDose = manualRx ? manualRx : newDoseStr;
    
    note += `\nDietary Advice:\n- Use iodised salt (Tata, Nirma, etc.); avoid Sindha namak (non-iodised)\n- Avoid Cabbage / Cauliflower (‡™ï‡´ã‡™¨‡´Ä / ‡™´‡´Å‡™≤‡™æ‡™µ‡™∞)\n`;

    if (finalRxDose) {
      let durationText = duration ? ` for ${duration}` : '';
      note += `\nAdv:\n- Tab. Thyroxine ${finalRxDose}${durationText} \n  (1 tablet OD empty stomach in the morning)`;
    }
    document.getElementById('note-box').value = note;
    
    saveFormData();
  }

  // ==========================================
  // LOCAL STORAGE (AUTOSAVE) LOGIC
  // ==========================================
  function saveFormData() {
    const formData = {
      name: document.getElementById('pt-name').value,
      age: document.getElementById('pt-age').value,
      gender: document.getElementById('pt-gender').value,
      moa: document.getElementById('pt-moa').value,
      date: document.getElementById('pt-date').value,
      dx: document.getElementById('pt-dx').value,
      dose: document.getElementById('pt-dose').value,
      wt: document.getElementById('pt-wt').value,
      bp: document.getElementById('pt-bp').value,
      hr: document.getElementById('pt-hr').value,
      tsh: document.getElementById('pt-tsh').value,
      compPoor: document.getElementById('comp-poor').checked,
      rxDose: document.getElementById('rx-dose').value,
      rxDuration: document.getElementById('rx-duration').value,
      rxFu: document.getElementById('rx-fu').value,
      customNote: document.getElementById('note-box').value 
    };
    localStorage.setItem('thyroidAutoSave', JSON.stringify(formData));
  }

  function loadFormData() {
    const saved = localStorage.getItem('thyroidAutoSave');
    if (saved) {
      const data = JSON.parse(saved);
      document.getElementById('pt-name').value = data.name || '';
      document.getElementById('pt-age').value = data.age || '';
      document.getElementById('pt-gender').value = data.gender || 'Female';
      document.getElementById('pt-moa').value = data.moa || '';
      if(data.date) document.getElementById('pt-date').value = data.date;
      document.getElementById('pt-dx').value = data.dx || 'K/C/O Hypothyroid';
      document.getElementById('pt-dose').value = data.dose || '';
      document.getElementById('pt-wt').value = data.wt || '';
      document.getElementById('pt-bp').value = data.bp || '';
      document.getElementById('pt-hr').value = data.hr || '';
      document.getElementById('pt-tsh').value = data.tsh || '';
      document.getElementById('comp-poor').checked = data.compPoor || false;
      document.getElementById('comp-good').checked = !(data.compPoor || false);
      document.getElementById('rx-dose').value = data.rxDose || '';
      document.getElementById('rx-duration').value = data.rxDuration || '';
      document.getElementById('rx-fu').value = data.rxFu || 'After 1 month with fresh S. TSH report';
      
      if(data.customNote) {
        document.getElementById('note-box').value = data.customNote;
        let tsh = parseFloat(data.tsh);
        if(!isNaN(tsh) && (tsh > 4.5 || tsh < 0.5)) {
            document.getElementById('compliance-box').classList.add('active');
            document.getElementById('pt-tsh').classList.add('tsh-abnormal');
        }
      } else {
        generateNote();
      }
    } else {
      document.getElementById('pt-date').valueAsDate = new Date();
      generateNote();
    }
  }

  // FIXED: Explicitly purges local storage and resets DOM fields directly to defeat browser caching
  function clearPatient() {
    if(confirm("Clear all data for the next patient?")) {
      localStorage.removeItem('thyroidAutoSave');
      
      document.getElementById('pt-name').value = '';
      document.getElementById('pt-age').value = '';
      document.getElementById('pt-gender').value = 'Female';
      document.getElementById('pt-moa').value = '';
      document.getElementById('pt-date').valueAsDate = new Date();
      document.getElementById('pt-dx').value = 'K/C/O Hypothyroid';
      document.getElementById('pt-dose').value = '';
      document.getElementById('pt-wt').value = '';
      document.getElementById('pt-bp').value = '';
      document.getElementById('pt-hr').value = '';
      document.getElementById('pt-tsh').value = '';
      document.getElementById('comp-good').checked = true;
      document.getElementById('rx-dose').value = '';
      document.getElementById('rx-duration').value = '';
      document.getElementById('rx-fu').value = 'After 1 month with fresh S. TSH report';

      document.getElementById('compliance-box').classList.remove('active');
      document.getElementById('pt-tsh').classList.remove('tsh-abnormal');

      generateNote(); // Triggers the blank note and forces a clean autosave state
    }
  }

  window.onload = loadFormData;

  // ==========================================
  // PRINT & COPY 
  // ==========================================
  function copyNote() {
    navigator.clipboard.writeText(document.getElementById('note-box').value).then(() => {
      let btn = document.getElementById('copy-btn'); btn.innerText = "‚úÖ Copied!"; setTimeout(() => btn.innerText = "üìã Copy Note", 2000);
    });
  }

  function preparePrint() {
    document.getElementById('pr-name').innerText = document.getElementById('pt-name').value || "........................";
    
    let age = document.getElementById('pt-age').value;
    let gender = document.getElementById('pt-gender').value.charAt(0);
    let moa = document.getElementById('pt-moa').value;
    
    let ageSexStr = age ? `${age} Yrs / ${gender}` : "..... Yrs / " + gender;
    if (moa) { ageSexStr += ` (MOA: ${moa})`; }
    document.getElementById('pr-age-sex').innerText = ageSexStr;
    
    let d = document.getElementById('pt-date').value;
    document.getElementById('pr-date').innerText = d ? new Date(d).toLocaleDateString('en-GB') : "..../..../......";

    document.getElementById('pr-wt').innerText = document.getElementById('pt-wt').value ? document.getElementById('pt-wt').value + " kg" : "____ kg";
    document.getElementById('pr-bp').innerText = document.getElementById('pt-bp').value ? document.getElementById('pt-bp').value + " mmHg" : "____ mmHg";
    document.getElementById('pr-hr').innerText = document.getElementById('pt-hr').value ? document.getElementById('pt-hr').value + " /min" : "____ /min";
    
    let tshVal = document.getElementById('pt-tsh').value;
    document.getElementById('pr-tsh').innerText = tshVal ? tshVal : "____";
    
    document.getElementById('pr-note').innerText = document.getElementById('note-box').value;
    document.getElementById('pr-fu').innerText = document.getElementById('rx-fu').value || "______________________";

    window.print();
  }
</script>

</body>
</html>
